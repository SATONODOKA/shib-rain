# 要件定義書：意図特定機能

## 1. 概要

### 1.1 目的
ユーザーが曖昧なワードを入力した際に、ローカルLLMと連動して動的な質問を2-3回行い、ユーザーの真の意図を特定した上で関連度の高いナレッジを表示する機能を実装する。

### 1.2 背景
- 現在のシステムでは、ユーザーが具体的なキーワードを入力しないと適切なナレッジが表示されない
- ユーザーは自分の知りたい内容を正確に表現できない場合が多い
- 意図を特定することで、より関連度の高いナレッジを提供できる

### 1.3 システム概要
- **フロントエンド**: HTML/CSS/JavaScript（既存システム拡張）
- **バックエンド**: Python FastAPI（既存システム拡張）
- **LLM**: Ollama（ローカル環境）
- **ナレッジベース**: Markdownファイル（既存構造）

## 2. 機能要件

### 2.1 基本機能

#### 2.1.1 曖昧性検出機能
- **機能概要**: ユーザーの入力が曖昧かどうかを判定する
- **判定基準**:
  - 単語数が3語以下
  - 一般的すぎるワード（「改善」「改革」「育成」など）
  - 業界・テーマが特定できないワード
  - 動詞のみの入力（「知りたい」「学びたい」など）

- **判定例**:
  - 「改善」→ 曖昧（一般的ワード）
  - 「建設業界」→ 曖昧（業界のみ、テーマ未特定）
  - 「女性活躍」→ 曖昧（テーマのみ、業界未特定）
  - 「建設業界の女性活躍」→ 明確（業界+テーマ）
  - 「建設業界の女性活躍の取り組み事例」→ 明確（具体的）

#### 2.1.2 意図特定質問生成機能
- **機能概要**: ローカルLLMを使用して、ユーザーの意図を特定するための質問を動的に生成
- **質問パターン**:
  1. **知識学習系**: 「業界の基礎知識を学びたいですか？それとも具体的な施策について知りたいですか？」
  2. **事例検索系**: 「社内での取り組み事例を知りたいですか？それとも他社の事例を知りたいですか？」
  3. **提案系**: 「弊社からの提案事例を知りたいですか？それとも社内の知識ベースを確認したいですか？」
  4. **課題解決系**: 「現在直面している課題の解決策を知りたいですか？それとも予防策を知りたいですか？」

#### 2.1.3 対話型意図特定機能
- **機能概要**: 2-3回の質問でユーザーの意図を段階的に特定
- **質問回数**: 最大3回まで
- **質問間隔**: ユーザーの回答を受けてから次の質問を生成
- **中断機能**: ユーザーが「やめる」「キャンセル」と入力した場合、通常の検索モードに戻る

- **対話フロー**:
  ```
  ユーザー入力 → 曖昧性判定 → 意図特定モード開始
  ↓
  第1質問生成 → ユーザー回答 → 第2質問生成
  ↓
  ユーザー回答 → 第3質問生成（必要に応じて）
  ↓
  ユーザー回答 → 意図特定完了 → ナレッジ表示
  ```

### 2.2 意図カテゴリ分類

#### 2.2.1 主要意図カテゴリ
1. **知識学習意図**
   - 業界基礎知識の学習
   - テーマ別知識の学習
   - 最新動向の把握

2. **事例検索意図**
   - 社内取り組み事例の確認
   - 他社事例の参考
   - 成功事例の分析

3. **提案・コンサルティング意図**
   - 弊社提案事例の確認
   - コンサルティング手法の学習
   - 提案書テンプレートの取得

4. **課題解決意図**
   - 現在の課題に対する解決策
   - 予防策・対策の検討
   - リスク管理手法の学習

5. **実践・運用意図**
   - 具体的な実施手順
   - 運用ノウハウの取得
   - 効果測定手法の学習

#### 2.2.2 副次的意図
- **緊急度**: 緊急対応が必要か、じっくり検討するか
- **対象者**: 経営層向け、管理職向け、一般社員向け
- **業界**: 建設業界、製造業、IT業界など
- **規模**: 大企業向け、中小企業向け

### 2.3 ナレッジ表示機能

#### 2.3.1 意図別ナレッジ表示
- **機能概要**: 特定された意図に基づいて、最適なナレッジファイルを表示
- **表示順序**:
  1. 意図に最も関連するナレッジ
  2. 補完的なナレッジ
  3. 関連する他のテーマのナレッジ

#### 2.3.2 意図別説明文生成
- **機能概要**: 特定された意図に基づいて、ナレッジの説明文をカスタマイズ
- **例**:
  - 知識学習意図: 「このナレッジでは、[テーマ]の基礎知識について詳しく説明しています」
  - 事例検索意図: 「このナレッジには、[テーマ]に関する具体的な取り組み事例が含まれています」

## 3. 技術要件

### 3.1 ローカルLLM連携

#### 3.1.1 質問生成プロンプト
```
あなたはユーザーの意図を特定する専門家です。以下の曖昧な入力に対して、ユーザーの真の意図を特定するための質問を1つ生成してください。

ユーザー入力: {user_input}
現在の質問回数: {question_count}/3

利用可能な意図カテゴリ:
1. 知識学習 - 業界やテーマの基礎知識を学びたい
2. 事例検索 - 具体的な取り組み事例を知りたい
3. 提案・コンサル - 提案事例やコンサル手法を知りたい
4. 課題解決 - 現在の課題に対する解決策を知りたい
5. 実践・運用 - 具体的な実施手順や運用ノウハウを知りたい

質問は以下の形式で生成してください:
- 選択肢形式（A or B）
- 具体的で分かりやすい
- ユーザーが迷わない内容

質問:
```

#### 3.1.2 意図特定プロンプト
```
ユーザーの回答から意図を特定してください。

ユーザー入力: {original_input}
質問1: {question1}
回答1: {answer1}
質問2: {question2}
回答2: {answer2}
質問3: {question3}
回答3: {answer3}

以下の形式で意図を特定してください:
{
  "primary_intent": "知識学習|事例検索|提案・コンサル|課題解決|実践・運用",
  "secondary_intent": {
    "urgency": "緊急|通常",
    "target": "経営層|管理職|一般社員",
    "industry": "建設業界|製造業|IT業界|その他",
    "scale": "大企業|中小企業"
  },
  "confidence": 0.0-1.0,
  "keywords": ["キーワード1", "キーワード2"]
}
```

### 3.2 フロントエンド要件

#### 3.2.1 UI/UX要件
- **意図特定モードの表示**: 通常のチャットと区別できる視覚的表示
- **質問の表示**: 明確で読みやすい質問表示
- **進捗表示**: 質問回数（1/3, 2/3, 3/3）の表示
- **中断ボタン**: 意図特定を中断して通常モードに戻るボタン
- **回答選択UI**: 選択肢形式の回答を簡単に選択できるUI

#### 3.2.2 状態管理
- **意図特定状態**: 現在が意図特定モードかどうかの管理
- **質問履歴**: 質問と回答の履歴管理
- **意図情報**: 特定された意図情報の保持

### 3.3 バックエンド要件

#### 3.3.1 API拡張
- **意図特定開始API**: `/intent/start`
- **質問生成API**: `/intent/question`
- **意図特定完了API**: `/intent/complete`
- **意図別ナレッジ検索API**: `/knowledge/search-by-intent`

#### 3.3.2 データ構造
```python
class IntentClarificationRequest(BaseModel):
    user_input: str
    chat_id: str

class IntentQuestion(BaseModel):
    question: str
    options: List[str]
    question_number: int
    max_questions: int

class IntentClarificationResponse(BaseModel):
    question: IntentQuestion
    is_ambiguous: bool

class IntentResult(BaseModel):
    primary_intent: str
    secondary_intent: Dict[str, str]
    confidence: float
    keywords: List[str]
    knowledge_files: List[Dict]
```

## 4. 非機能要件

### 4.1 パフォーマンス要件
- **質問生成時間**: 3秒以内
- **意図特定時間**: 5秒以内
- **ナレッジ表示時間**: 2秒以内

### 4.2 可用性要件
- **LLM接続失敗時**: フォールバック機能で通常検索モードに切り替え
- **質問生成失敗時**: デフォルト質問セットを使用

### 4.3 ユーザビリティ要件
- **直感的操作**: ユーザーが迷わない操作フロー
- **中断可能**: いつでも意図特定を中断できる

## 5. 実装計画

### 5.1 Phase 1: 基本機能実装（1週間）
1. 曖昧性検出機能の実装
2. 基本的な質問生成機能の実装
3. フロントエンドUIの基本実装

### 5.2 Phase 2: LLM連携（1週間）
1. ローカルLLM連携の実装
2. 対話型意図特定機能の実装
3. 意図別ナレッジ表示機能の実装

## 6. 成功指標

### 6.1 定量的指標
- **意図特定精度**: 80%以上
- **中断率**: 20%以下
- **平均質問回数**: 2.5回以下

### 6.2 定性的指標
- ユーザーがより関連度の高いナレッジを得られる
- ナレッジの活用率が向上する

## 7. ユースケース

### 7.1 主要ユースケース

#### 7.1.1 ユースケース1: 知識学習意図の特定
- **シナリオ**: コンサルタントが建設業界の基礎知識を学びたい
- **入力**: 「建設業界」
- **期待される質問**: 「建設業界の基礎知識を学びたいですか？それとも具体的な施策について知りたいですか？」
- **期待される結果**: 知識学習意図、建設業界

#### 7.1.2 ユースケース2: 事例検索意図の特定
- **シナリオ**: 営業担当者が女性活躍の成功事例を探したい
- **入力**: 「女性活躍」
- **期待される質問**: 「女性活躍の取り組み事例を知りたいですか？それとも基礎知識を学びたいですか？」
- **期待される結果**: 事例検索意図、女性活躍

#### 7.1.3 ユースケース3: 課題解決意図の特定
- **シナリオ**: 人事担当者が組織風土改革の課題解決策を探したい
- **入力**: 「組織風土改革」
- **期待される質問**: 「組織風土改革の課題解決策を知りたいですか？それとも基礎知識を学びたいですか？」
- **期待される結果**: 課題解決意図、組織風土改革

## 8. リスク・課題

### 8.1 技術的リスク
- **LLM応答品質**: ローカルLLMの応答品質が不安定な場合
- **質問生成精度**: 適切な質問が生成されない場合
- **意図特定精度**: ユーザーの意図を誤解する場合

### 8.2 対策
- **フォールバック機能**: LLM失敗時の代替手段
- **質問テンプレート**: 事前定義された質問セット
- **ユーザーフィードバック**: 意図特定の精度向上 