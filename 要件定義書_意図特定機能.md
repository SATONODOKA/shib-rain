# 要件定義書：意図特定機能

## 1. 概要

### 1.1 目的
ユーザーが曖昧なワードを入力した際に、ローカルLLMが対話を通じてユーザーのニーズを具体化し、Obsidian上で関連性の高いナレッジファイルを5つ程度表示する機能を実装する。

### 1.2 背景
- 現在のシステムでは、ユーザーが具体的なキーワードを入力しないと適切なナレッジが表示されない
- ユーザーは自分の知りたい内容を正確に表現できない場合が多い
- LLMが対話を通じてニーズを具体化することで、より関連度の高いナレッジを提供できる

### 1.3 システム概要
- **フロントエンド**: HTML/CSS/JavaScript（既存システム拡張）
- **バックエンド**: Python FastAPI（既存システム拡張）
- **LLM**: Ollama（ローカル環境）
- **ナレッジベース**: Obsidian Markdownファイル（既存構造）

### 1.4 LLMの位置付けと扱い方針
**重要**: 本システムにおけるLLMは、ユーザーのニーズ理解とナレッジ検索の中心的な役割を担う。以下の方針を徹底する：

#### 1.4.1 LLM完全信頼原則
- **思考・判断の委任**: 曖昧性検出、キーワード生成、検索戦略の決定をLLMに完全委任
- **制約最小化**: コードでの制約は最小限に抑え、LLMのポテンシャルを最大限活用
- **自然な対話**: 固定パターンや強制的な質問回数制限を設けず、文脈に応じた自然な対話を実現

#### 1.4.2 プロンプト設計原則
- **シンプル性**: 前提条件と簡単な指示のみ、詳細な制約は排除
- **思考促進**: LLMに思考を促すプロンプト設計
- **自由度確保**: 具体的なワード指定や固定パターンを避け、LLMの創造性を活かす

#### 1.4.3 実装時の注意事項
- **要件定義書参照**: コーディング時は本要件定義書を随時参照し、LLMの位置付けを逸脱しない
- **制約チェック**: 新しい機能追加時は、LLMの自由度を制限していないか確認
- **テスト方針**: LLMの応答品質と自然な対話の実現を重点的にテスト

## 2. 機能要件

### 2.1 基本機能

#### 2.1.1 LLM対話型ニーズ具体化機能
- **機能概要**: ローカルLLMがユーザーと対話を通じてニーズを具体化する
- **対話フロー**:
  ```
  ユーザー入力 → LLMがニーズを判断 → 必要に応じて質問 → ユーザー回答 → ニーズ具体化完了 → ナレッジ検索・表示
  ```

- **LLMの役割**:
  - ユーザーの曖昧な入力を理解
  - 必要に応じて具体的な質問を生成
  - 対話を通じてユーザーの真のニーズを特定
  - 特定されたニーズに基づいて関連ナレッジを選択

#### 2.1.2 Obsidian検索機能
- **機能概要**: LLMが特定したニーズに基づいてObsidian上で関連ファイルを検索
- **検索対象**:
  - ファイル名（業界名、テーマ名、会社名など）
  - タグ（業界、能力開発テーマ、バリューチェーンなど）
  - ファイル内容のキーワード

- **検索方法**:
  - LLMが適切な検索クエリを生成
  - Obsidianの検索機能を活用
  - 関連性の高いファイルを5つ程度選択

#### 2.1.3 ナレッジ表示機能
- **機能概要**: 検索結果を関連性順に表示
- **表示内容**:
  - ファイル名とパス
  - ファイルの概要
  - Obsidianで開くリンク

### 2.2 対話パターン

#### 2.2.1 質問パターン
LLMが自由に質問を生成し、ユーザーのニーズを具体化する。

#### 2.2.2 対話例
LLMが文脈に応じて自然な対話を展開する。

### 2.3 検索キーワード生成

#### 2.3.1 LLMによる検索実行
LLMが対話を通じてユーザーのニーズを理解し、適切な検索を実行する。

#### 2.3.2 検索クエリ構築
LLMが自由に検索クエリを構築する。

## 3. 技術要件

### 3.1 ローカルLLM連携

#### 3.1.1 シンプルなプロンプト
```
あなたはユーザーのニーズを質問を通じて具体化したうえで、Obsidian上の関連性の高いファイルやナレッジを5つほど選び、表示させてください。

ユーザー入力: {user_input}
現在の質問回数: {question_count}

質問が必要な場合は、ユーザーのニーズを具体化するための質問を1つ生成してください。
十分な情報が得られた場合は、関連性の高いナレッジファイルを5つ程度選択して表示してください。
```

#### 3.1.2 検索実行プロンプト
```
ユーザーのニーズに基づいて、Obsidianで関連性の高いファイルを5つ程度検索してください。

ユーザーニーズ: {user_needs}

以下の形式で検索結果を返してください:
{
  "files": [
    {
      "path": "ファイルパス",
      "title": "ファイルタイトル",
      "relevance": "関連性の説明"
    }
  ],
  "explanation": "検索の説明"
}
```

### 3.2 フロントエンド要件

#### 3.2.1 UI/UX要件
- **意図特定モードの表示**: 通常のチャットと区別できる視覚的表示
- **LLM質問の表示**: 明確で読みやすい質問表示
- **進捗表示**: 質問回数の表示（任意）
- **中断ボタン**: 意図特定を中断して通常モードに戻るボタン
- **検索結果表示**: 関連性の高いナレッジファイルの表示

#### 3.2.2 状態管理
- **意図特定状態**: 現在が意図特定モードかどうかの管理
- **質問履歴**: 質問と回答の履歴管理
- **ニーズ情報**: 特定されたニーズ情報の保持

### 3.3 バックエンド要件

#### 3.3.1 API拡張
- **意図特定開始API**: `/intent/start`
- **質問生成API**: `/intent/question`
- **意図特定完了API**: `/intent/complete`
- **Obsidian検索API**: `/knowledge/search-obsidian`

#### 3.3.2 データ構造
```python
class IntentClarificationRequest(BaseModel):
    user_input: str
    chat_id: str

class IntentQuestion(BaseModel):
    question: str
    question_number: int
    is_complete: bool = False

class IntentClarificationResponse(BaseModel):
    question: IntentQuestion
    is_ambiguous: bool

class UserNeeds(BaseModel):
    description: str
    keywords: List[str]

class ObsidianSearchRequest(BaseModel):
    user_needs: UserNeeds

class ObsidianSearchResult(BaseModel):
    files: List[Dict]
    explanation: str
```

## 4. 非機能要件

### 4.1 パフォーマンス要件
- **LLM応答時間**: 5秒以内
- **検索実行時間**: 3秒以内
- **ナレッジ表示時間**: 2秒以内

### 4.2 可用性要件
- **LLM接続失敗時**: フォールバック機能で通常検索モードに切り替え
- **検索失敗時**: 基本的なキーワード検索にフォールバック

### 4.3 ユーザビリティ要件
- **直感的操作**: ユーザーが迷わない操作フロー
- **中断可能**: いつでも意図特定を中断できる

## 5. 実装計画

### 5.1 Phase 1: LLM対話機能実装（1週間）
1. ローカルLLM連携の実装
2. 対話型ニーズ具体化機能の実装
3. フロントエンドUIの基本実装

### 5.2 Phase 2: Obsidian検索機能実装（1週間）
1. Obsidian検索APIの実装
2. LLMによる検索実行機能の実装
3. 検索結果表示機能の実装

## 6. 成功指標

### 6.1 定量的指標
- **ニーズ特定精度**: 85%以上
- **中断率**: 15%以下
- **平均質問回数**: 文脈に応じて変動
- **検索結果関連性**: 80%以上

### 6.2 定性的指標
- ユーザーがより関連度の高いナレッジを得られる
- ナレッジの活用率が向上する
- ユーザーの満足度が向上する

## 7. ユースケース

### 7.1 主要ユースケース

#### 7.1.1 ユースケース1: 業界・テーマ特定
- **シナリオ**: コンサルタントが建設業界の組織風土改革について知りたい
- **入力**: 「組織風土改革」
- **期待される対話**: 業界の特定 → テーマの詳細化
- **期待される結果**: 建設業界の組織風土改革に関するナレッジ

#### 7.1.2 ユースケース2: 課題・施策特定
- **シナリオ**: 人事担当者が離職率改善の施策を探したい
- **入力**: 「離職率」
- **期待される対話**: 業界特定 → 課題の詳細化 → 施策の特定
- **期待される結果**: 離職率改善に関する具体的な施策ナレッジ

#### 7.1.3 ユースケース3: バリューチェーン特定
- **シナリオ**: 営業担当者が管理職向けの研修事例を探したい
- **入力**: 「管理職研修」
- **期待される対話**: 業界特定 → 対象者の詳細化
- **期待される結果**: 管理職向け研修に関するナレッジ

## 8. リスク・課題

### 8.1 技術的リスク
- **LLM応答品質**: ローカルLLMの応答品質が不安定な場合
- **検索精度**: Obsidian検索の精度が低い場合
- **ニーズ特定精度**: ユーザーのニーズを誤解する場合

### 8.2 対策
- **フォールバック機能**: LLM失敗時の代替手段
- **検索クエリ最適化**: 複数の検索パターンを試行
- **ユーザーフィードバック**: ニーズ特定の精度向上

## 9. 制約事項

### 9.1 コード制約
- **曖昧性検出**: コードでの曖昧性検出は禁止、LLMに完全委任
- **キーワード直接指定**: コードでのキーワード直接指定は禁止
- **検索ロジック**: 単純な文字列マッチングは禁止、LLMに検索を委任
- **プロンプト**: シンプルな前提条件と指示のみ、詳細な制約は禁止

### 9.2 LLM制約
- **対話回数**: 文脈に応じて変動
- **質問形式**: LLMが自由に決定
- **応答時間**: 5秒以内を目標とする
- **検索結果数**: 5つ程度のファイルを選択

## 10. 開発ガイドライン

### 10.1 コーディング時の注意事項
**重要**: 本要件定義書のLLMの位置付けと扱い方針（1.4節）を常に参照し、以下の点を徹底する：

#### 10.1.1 要件定義書参照義務
- **実装前確認**: 新しい機能実装前に本要件定義書の1.4節を必ず確認
- **コードレビュー**: LLMの自由度を制限していないか定期的にチェック
- **設計変更時**: システム設計変更時はLLMの位置付けへの影響を評価

#### 10.1.2 LLM制約チェックリスト
実装時に以下の項目をチェックし、LLMの自由度を制限していないことを確認：
- [ ] 固定の質問パターンを強制していない
- [ ] 具体的なキーワードを直接指定していない
- [ ] 検索ロジックでLLMの判断を上書きしていない
- [ ] プロンプトがシンプルで制約が最小限
- [ ] 文脈に応じた自然な対話が可能

#### 10.1.3 テスト方針
- **LLM応答テスト**: 自然な対話の実現を重点的にテスト
- **制約チェックテスト**: LLMの自由度が制限されていないことを確認
- **ユーザビリティテスト**: ユーザーが自然にナレッジにアクセスできることを確認

### 10.2 継続的改善
- **LLM応答品質監視**: 定期的にLLMの応答品質を評価
- **ユーザーフィードバック**: ユーザーからのフィードバックを収集・反映
- **要件定義書更新**: システム改善に応じて本要件定義書を更新 