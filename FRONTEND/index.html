<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒŠãƒ¬ãƒƒã‚¸ãƒãƒ£ãƒƒãƒˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #ffffff;
      color: #374151;
      height: 100vh;
      display: flex;
    }

    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
    .sidebar {
      width: 260px;
      background: #f7f7f8;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
    }

    .logo {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
    }

    .sidebar-nav {
      flex: 1;
      padding: 8px;
      overflow-y: auto;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      margin: 2px 0;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
      font-size: 14px;
    }

    .nav-item:hover {
      background: #f3f4f6;
    }

    .nav-item.active {
      background: #e5e7eb;
    }

    .nav-icon {
      width: 16px;
      height: 16px;
      margin-right: 12px;
      opacity: 0.7;
    }

    .nav-separator {
      height: 1px;
      background: #e5e7eb;
      margin: 8px 0;
    }

    .chat-history {
      flex: 1;
      overflow-y: auto;
    }

    .chat-history-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      margin: 2px 0;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
      font-size: 13px;
      color: #6b7280;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .chat-history-item:hover {
      background: #f3f4f6;
    }

    .chat-history-item.active {
      background: #e5e7eb;
      color: #111827;
    }

    .chat-history-icon {
      width: 16px;
      height: 16px;
      margin-right: 12px;
      opacity: 0.7;
      flex-shrink: 0;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .chat-header {
      padding: 8px 12px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-title {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
    }

    .user-profile {
      width: 32px;
      height: 32px;
      background: #10a37f;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
    }

    /* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .welcome-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 32px 16px;
    }

    .welcome-title {
      font-size: 28px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }

    .welcome-subtitle {
      font-size: 15px;
      color: #6b7280;
      margin-bottom: 32px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      display: none;
    }

    .message {
      display: flex;
      margin-bottom: 8px;
      animation: fadeIn 0.3s ease-in;
    }

    .message.user {
      justify-content: flex-end;
    }

    .message-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      margin: 0 6px;
      flex-shrink: 0;
    }

    .message.user .message-avatar {
      background: #10a37f;
      color: white;
    }

    .message.ai .message-avatar {
      background: #8e8ea0;
      color: white;
    }

    .message-content {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 10px;
      line-height: 1.4;
      font-size: 14px;
    }

    .message.user .message-content {
      background: #10a37f;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.ai .message-content {
      background: #f7f7f8;
      color: #374151;
      border-bottom-left-radius: 4px;
    }

    .message-content h3 {
      margin: 12px 0 6px 0;
      font-size: 16px;
      font-weight: 600;
      color: #111827;
    }

    .message-content h4 {
      margin: 10px 0 4px 0;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    .message-content ul {
      margin: 8px 0;
      padding-left: 20px;
    }

    .message-content li {
      margin: 4px 0;
    }

    .message-content pre {
      background: #f3f4f6;
      padding: 8px 12px;
      border-radius: 6px;
      margin: 8px 0;
      overflow-x: auto;
    }

    .message-content code {
      background: #f3f4f6;
      padding: 2px 4px;
      border-radius: 3px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
    }

    .message-content strong {
      font-weight: 600;
      color: #111827;
    }

    .message-content em {
      font-style: italic;
      color: #6b7280;
    }

    /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
    .input-container {
      padding: 8px;
      border-top: 1px solid #e5e7eb;
      background: white;
    }

    .input-wrapper {
      max-width: 768px;
      margin: 0 auto;
      position: relative;
    }

    .input-box {
      width: 100%;
      padding: 12px 48px 12px 16px;
      border: 1px solid #d1d5db;
      border-radius: 24px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.2s;
      background: white;
    }

    .input-box:focus {
      border-color: #10a37f;
      box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.1);
    }

    .input-actions {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .action-button {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.2s;
      color: #6b7280;
    }

    .action-button:hover {
      background: #f3f4f6;
    }

    .send-button {
      background: #10a37f;
      color: white;
    }

    .send-button:hover {
      background: #0d8c6c;
    }

    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }
      
      .message-content {
        max-width: 85%;
      }
    }

    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    /* æ¤œç´¢çµæœã‚¹ã‚¿ã‚¤ãƒ« */
    .search-results {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      padding: 6px;
      margin-top: 4px;
      max-height: 180px;
      overflow-y: auto;
    }

    .search-results-header {
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 4px;
      margin-bottom: 4px;
    }

    .search-results-header h3 {
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 2px;
    }

    .search-results-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .search-result-item {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 3px;
      padding: 4px 6px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .search-result-item:hover {
      background: #f3f4f6;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
      font-size: 10px;
      color: #6b7280;
    }

    .result-category {
      background: #e0e7ff;
      color: #4f46e5;
      padding: 1px 4px;
      border-radius: 2px;
      font-weight: bold;
    }

    .result-title {
      font-size: 12px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 1px;
    }

    .result-description {
      font-size: 10px;
      color: #6b7280;
      margin-bottom: 2px;
      line-height: 1.2;
    }

    .result-keywords {
      display: flex;
      flex-wrap: wrap;
      gap: 2px;
    }

    .keyword-tag {
      background: #f3f4f6;
      color: #4b5563;
      padding: 1px 4px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: bold;
    }

    .result-actions {
      margin-top: 2px;
      text-align: right;
    }

    .open-file-btn {
      background: #10a37f;
      color: white;
      border: none;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .open-file-btn:hover {
      background: #0d8a6f;
    }

    .search-container {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
    }

    .search-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      background: white;
    }

    .search-input:focus {
      outline: none;
      border-color: #10a37f;
      box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.1);
    }

    .chat-history-item.highlight {
      background: #fef3c7;
      border-left: 3px solid #f59e0b;
    }

    .chat-history-item .highlight-text {
      background: #fef3c7;
      color: #92400e;
      padding: 1px 2px;
      border-radius: 2px;
    }

    /* æ„å›³ç‰¹å®šãƒ¢ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .intent-clarification-container {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: 2px solid #4f46e5;
      border-radius: 12px;
      padding: 16px;
      margin: 8px 0;
      color: white;
    }

    .intent-header {
      font-weight: bold;
      margin-bottom: 12px;
      font-size: 16px;
    }

    .intent-progress {
      color: rgba(255,255,255,0.8);
      font-size: 12px;
      margin-bottom: 8px;
    }

    .intent-question {
      font-size: 16px;
      line-height: 1.5;
      margin-bottom: 16px;
    }

    .intent-cancel {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 6px;
      padding: 8px 16px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      margin-top: 12px;
    }

    .intent-cancel:hover {
      background: rgba(255,255,255,0.3);
    }
  </style>
</head>
<body>
  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="logo">N</div>
    </div>
    
    <div class="sidebar-nav">
      <div class="nav-item active" id="new-chat">
        <span class="nav-icon">âœï¸</span>
        æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ
      </div>
      <div class="nav-item" id="search-toggle">
        <span class="nav-icon">ğŸ”</span>
        ãƒãƒ£ãƒƒãƒˆã‚’æ¤œç´¢
      </div>
      
      <!-- æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ -->
      <div class="search-container" id="search-container" style="display: none;">
        <input 
          type="text" 
          class="search-input" 
          id="chat-search-input" 
          placeholder="ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’æ¤œç´¢..."
          autocomplete="off"
        >
      </div>
      
      <div class="nav-separator"></div>
      
      <div class="chat-history" id="chat-history">
        <!-- ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
      </div>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="main-content">
    <div class="chat-header">
      <div class="chat-title">ãƒŠãƒ¬ãƒƒã‚¸ãƒãƒ£ãƒƒãƒˆ</div>
      <div class="user-profile">U</div>
    </div>

    <div class="chat-container">
      <!-- ã‚¦ã‚§ãƒ«ã‚«ãƒ ç”»é¢ -->
      <div class="welcome-screen" id="welcome-screen">
        <h1 class="welcome-title">ä»Šæ—¥ã¯ã©ã†ã—ã¾ã—ãŸã‹ï¼Ÿ</h1>
        <p class="welcome-subtitle">æ¥­ç•ŒçŸ¥è­˜ã‚„èƒ½åŠ›é–‹ç™ºã«ã¤ã„ã¦ã€ä½•ã§ã‚‚ãŠèã‹ã›ãã ã•ã„</p>
      </div>

      <!-- ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
      <div class="chat-messages" id="chat-messages">
        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
      </div>
    </div>

    <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
    <div class="input-container">
      <div class="input-wrapper">
        <input 
          type="text" 
          class="input-box" 
          id="user-input" 
          placeholder="è³ªå•ã—ã¦ã¿ã¾ã—ã‚‡ã†"
          autocomplete="off"
        >
        <div class="input-actions">
          <button class="action-button" title="ãƒ„ãƒ¼ãƒ«">
            <span>ğŸ”§</span>
          </button>
          <button class="action-button" title="éŸ³å£°å…¥åŠ›">
            <span>ğŸ¤</span>
          </button>
          <button class="action-button send-button" id="send-button" title="é€ä¿¡">
            <span>â¤</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const welcomeScreen = document.getElementById('welcome-screen');
    const chatMessages = document.getElementById('chat-messages');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const chatHistory = document.getElementById('chat-history');
    const newChatButton = document.getElementById('new-chat');

    let currentChatId = null;
    let chatSessions = [];
    let sessionCounter = 0;
    let knowledgeFiles = []; // ãƒŠãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆ
    let searchToggle = document.getElementById('search-toggle');
    let searchContainer = document.getElementById('search-container');
    let chatSearchInput = document.getElementById('chat-search-input');

    // æ„å›³ç‰¹å®šæ©Ÿèƒ½ã®çŠ¶æ…‹ç®¡ç†
    let intentClarificationState = {
        isActive: false,
        currentQuestion: 1,
        maxQuestions: 3,
        questionHistory: [],
        answerHistory: [],
        userIntent: null,
        originalInput: ""
    };

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®è¨­å®š
    const STORAGE_KEY = 'shibu_rain_chat_history';
    const MAX_SESSIONS = 50; // æœ€å¤§ä¿å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°

    // ãƒŠãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹é€ 
    const knowledgeFileStructure = [
      {
        path: 'KNOWLEDGE/æ¥­ç•Œåˆ¥/å»ºè¨­æ¥­ç•Œ_æ¥­ç•Œä¸€èˆ¬.md',
        title: 'å»ºè¨­æ¥­ç•Œ_æ¥­ç•Œä¸€èˆ¬',
        category: 'æ¥­ç•Œåˆ¥',
        keywords: ['å»ºè¨­æ¥­ç•Œ', 'æ¥­ç•Œä¸€èˆ¬', 'å»ºè¨­', 'ç¾å ´', 'å·¥äº‹'],
        description: 'å»ºè¨­æ¥­ç•Œã®å…¨ä½“åƒã€ç‰¹å¾´ã€èª²é¡Œã€å‹•å‘ã‚’ã¾ã¨ã‚ãŸãƒŠãƒ¬ãƒƒã‚¸'
      },
      {
        path: 'KNOWLEDGE/æ¥­ç•Œåˆ¥/å»ºè¨­æ¥­ç•Œ_ç¾å ´è·äºº.md',
        title: 'å»ºè¨­æ¥­ç•Œ_ç¾å ´è·äºº',
        category: 'æ¥­ç•Œåˆ¥',
        keywords: ['å»ºè¨­æ¥­ç•Œ', 'ç¾å ´è·äºº', 'æŠ€èƒ½è€…', 'å¤§å·¥', 'å·¦å®˜', 'ç¾å ´'],
        description: 'å»ºè¨­æ¥­ç•Œã®ç¾å ´è·äººã«é–¢ã™ã‚‹ç‰¹å¾´ã€èª²é¡Œã€æ”¹å–„æ–½ç­–ã‚’ã¾ã¨ã‚ãŸãƒŠãƒ¬ãƒƒã‚¸'
      },
      {
        path: 'KNOWLEDGE/èƒ½åŠ›é–‹ç™ºãƒ†ãƒ¼ãƒ/çµ„ç¹”é¢¨åœŸæ”¹é©_å»ºè¨­æ¥­ç•Œ.md',
        title: 'çµ„ç¹”é¢¨åœŸæ”¹é©_å»ºè¨­æ¥­ç•Œ',
        category: 'èƒ½åŠ›é–‹ç™ºãƒ†ãƒ¼ãƒ',
        keywords: ['çµ„ç¹”é¢¨åœŸæ”¹é©', 'å»ºè¨­æ¥­ç•Œ', 'çµ„ç¹”æ–‡åŒ–', 'é¢¨åœŸæ”¹é©'],
        description: 'çµ„ç¹”é¢¨åœŸæ”¹é©ãƒ†ãƒ¼ãƒã®å»ºè¨­æ¥­ç•Œå‘ã‘ãƒŠãƒ¬ãƒƒã‚¸'
      },
      {
        path: 'KNOWLEDGE/èƒ½åŠ›é–‹ç™ºãƒ†ãƒ¼ãƒ/å¥³æ€§æ´»èº_å»ºè¨­æ¥­ç•Œ.md',
        title: 'å¥³æ€§æ´»èº_å»ºè¨­æ¥­ç•Œ',
        category: 'èƒ½åŠ›é–‹ç™ºãƒ†ãƒ¼ãƒ',
        keywords: ['å¥³æ€§æ´»èº', 'å»ºè¨­æ¥­ç•Œ', 'å¥³æ€§', 'ãƒ€ã‚¤ãƒãƒ¼ã‚·ãƒ†ã‚£', 'å¥³æ€§ç®¡ç†è·'],
        description: 'å¥³æ€§æ´»èºãƒ†ãƒ¼ãƒã®å»ºè¨­æ¥­ç•Œå‘ã‘ãƒŠãƒ¬ãƒƒã‚¸'
      }
    ];

    // ãƒŠãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
    function searchKnowledgeFiles(query) {
      const results = [];
      const queryLower = query.toLowerCase();
      
      for (const file of knowledgeFileStructure) {
        let score = 0;
        
        // ã‚¿ã‚¤ãƒˆãƒ«ã§ã®ãƒãƒƒãƒãƒ³ã‚°
        if (file.title.toLowerCase().includes(queryLower)) {
          score += 10;
        }
        
        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ã®ãƒãƒƒãƒãƒ³ã‚°
        for (const keyword of file.keywords) {
          if (keyword.toLowerCase().includes(queryLower)) {
            score += 5;
          }
        }
        
        // èª¬æ˜ã§ã®ãƒãƒƒãƒãƒ³ã‚°
        if (file.description.toLowerCase().includes(queryLower)) {
          score += 3;
        }
        
        // ã‚«ãƒ†ã‚´ãƒªã§ã®ãƒãƒƒãƒãƒ³ã‚°
        if (file.category.toLowerCase().includes(queryLower)) {
          score += 2;
        }
        
        if (score > 0) {
          results.push({
            ...file,
            score: score
          });
        }
      }
      
      // ã‚¹ã‚³ã‚¢ã§ã‚½ãƒ¼ãƒˆ
      results.sort((a, b) => b.score - a.score);
      return results;
    }

    // æ¤œç´¢çµæœã‚’è¡¨ç¤º
    function displaySearchResults(results, query) {
      const resultsHtml = results.map(file => `
        <div class="search-result-item">
          <div class="result-header">
            <span class="result-category">${file.category}</span>
            <span class="result-score">é–¢é€£åº¦: ${file.score}</span>
          </div>
          <div class="result-title">${file.title}</div>
          <div class="result-description">${file.description}</div>
          <div class="result-keywords">
            ${file.keywords.map(keyword => `<span class="keyword-tag">${keyword}</span>`).join('')}
          </div>
          <div class="result-actions">
            <button class="open-file-btn" onclick="openKnowledgeFile('${file.path}')">
              ğŸ“„ Obsidianã§é–‹ã
            </button>
          </div>
        </div>
      `).join('');
      
      return `
        <div class="search-results">
          <div class="search-results-header">
            <h3>ã€Œ${query}ã€ã®æ¤œç´¢çµæœ (${results.length}ä»¶)</h3>
          </div>
          <div class="search-results-list">
            ${resultsHtml}
          </div>
        </div>
      `;
    }

    // ãƒŠãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
    function openKnowledgeFile(filePath) {
      // Obsidianã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥é–‹ã
      const obsidianUrl = `obsidian://open?vault=Obsidian%20Vault&file=${encodeURIComponent(filePath)}`;
      
      // æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§Obsidianã‚’é–‹ã
      window.open(obsidianUrl, '_blank');
    }

    // æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆé–‹å§‹
    function startNewChat() {
      // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ã‚¯ãƒªã‚¢
      chatMessages.innerHTML = '';
      welcomeScreen.style.display = 'flex';
      chatMessages.style.display = 'none';
      
      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.querySelectorAll('.nav-item, .chat-history-item').forEach(item => {
        item.classList.remove('active');
      });
      newChatButton.classList.add('active');
      
      currentChatId = null;
      
      // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã‚’éè¡¨ç¤º
      searchContainer.style.display = 'none';
      chatSearchInput.value = '';
      
      userInput.focus();
    }

    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ 
    function addChatHistoryItem(title, chatId) {
      const historyItem = document.createElement('div');
      historyItem.className = 'chat-history-item';
      historyItem.setAttribute('data-chat-id', chatId);
      
      historyItem.innerHTML = `
        <span class="chat-history-icon">ğŸ’¬</span>
        <span class="chat-history-title">${title}</span>
      `;
      
      historyItem.addEventListener('click', () => {
        loadChatSession(chatId);
      });
      
      chatHistory.appendChild(historyItem);
      
      // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ä¿å­˜
      saveChatHistory();
    }

    // ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿
    function loadChatSession(chatId) {
      const session = chatSessions.find(s => s.id === chatId);
      if (!session) return;
      
      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('.nav-item, .chat-history-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`[data-chat-id="${chatId}"]`).classList.add('active');
      
      // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      chatMessages.innerHTML = '';
      session.messages.forEach(msg => {
        addMessageToDisplay(msg.content, msg.sender);
      });
      
      welcomeScreen.style.display = 'none';
      chatMessages.style.display = 'block';
      currentChatId = chatId;
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å‡¦ç†
    function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;

      // æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã®å ´åˆã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
      if (!currentChatId) {
        sessionCounter++;
        currentChatId = `chat_${sessionCounter}`;
        
        // ãƒãƒ£ãƒƒãƒˆã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆï¼ˆæœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ï¼‰
        const title = message.length > 20 ? message.substring(0, 20) + '...' : message;
        addChatHistoryItem(title, currentChatId);
        
        chatSessions.push({
          id: currentChatId,
          title: title,
          messages: []
        });
      }

      // ã‚¦ã‚§ãƒ«ã‚«ãƒ ç”»é¢ã‚’éè¡¨ç¤º
      welcomeScreen.style.display = 'none';
      chatMessages.style.display = 'block';

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
      addMessage(message, 'user');
      
      // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
      userInput.value = '';

      // æ„å›³ç‰¹å®šãƒ¢ãƒ¼ãƒ‰ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ãªã„å ´åˆã®ã¿ã€æ„å›³ç‰¹å®šã‚’è©¦è¡Œ
      if (!intentClarificationState.isActive) {
        // æ„å›³ç‰¹å®šã‚’é–‹å§‹
        setTimeout(async () => {
          const response = await startIntentClarification(message);
          if (response) {
            // æ„å›³ç‰¹å®šãŒé–‹å§‹ã•ã‚Œãªã‹ã£ãŸå ´åˆã¯é€šå¸¸ã®å¿œç­”ã‚’ç”Ÿæˆ
            addMessage(response, 'ai');
          }
          // æ„å›³ç‰¹å®šãŒé–‹å§‹ã•ã‚ŒãŸå ´åˆã¯ã€startIntentClarificationå†…ã§è³ªå•ãŒè¡¨ç¤ºã•ã‚Œã‚‹
        }, 1000);
      } else {
        // æ„å›³ç‰¹å®šãƒ¢ãƒ¼ãƒ‰ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆã¯ã€å›ç­”ã¨ã—ã¦å‡¦ç†
        setTimeout(async () => {
          await processIntentAnswer(message);
        }, 1000);
      }
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
    function addMessage(content, sender) {
      // ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜
      if (currentChatId) {
        const session = chatSessions.find(s => s.id === currentChatId);
        if (session) {
          session.messages.push({ content, sender });
          // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ä¿å­˜
          saveChatHistory();
        }
      }
      
      addMessageToDisplay(content, sender);
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã«è¿½åŠ 
    function addMessageToDisplay(content, sender) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = sender === 'user' ? 'U' : 'AI';
      
      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      
      // é–¢é€£ãƒŠãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã®HTMLãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      if (content.includes('<div class="search-results">')) {
        // HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’åˆ†å‰²ã—ã¦å‡¦ç†
        const parts = content.split('<div class="search-results">');
        const textPart = parts[0];
        const htmlPart = '<div class="search-results">' + parts[1];
        
        // ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†ã‚’å‡¦ç†
        const processedText = processMessageContent(textPart);
        messageContent.innerHTML = processedText + htmlPart;
      } else {
        // é€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆå‡¦ç†
        const processedContent = processMessageContent(content);
        messageContent.innerHTML = processedContent;
      }
      
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(messageContent);
      
      chatMessages.appendChild(messageDiv);
      
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã®å‡¦ç†ï¼ˆæ”¹è¡Œã€å¤ªå­—ã€ãƒªã‚¹ãƒˆç­‰ï¼‰
    function processMessageContent(content) {
      // ç©ºã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™
      if (!content || content.trim() === '') {
        return content;
      }
      
      let processed = content;
      
      // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šæ”¹è¡Œã®æ•°ã‚’ç¢ºèª
      const originalNewlines = (content.match(/\n/g) || []).length;
      
      // 1. ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®å‡¦ç†ï¼ˆå…ˆã«å‡¦ç†ï¼‰
      processed = processed.replace(/```([\s\S]*?)```/g, '<pre style="background: #f3f4f6; padding: 8px 12px; border-radius: 6px; margin: 8px 0; overflow-x: auto;"><code>$1</code></pre>');
      
      // 2. ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰ã®å‡¦ç†
      processed = processed.replace(/`([^`]+)`/g, '<code style="background: #f3f4f6; padding: 2px 4px; border-radius: 3px; font-family: monospace; font-size: 12px;">$1</code>');
      
      // 3. å¤ªå­—ã®å‡¦ç† (**text** â†’ <strong>text</strong>)
      processed = processed.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      
      // 4. æ–œä½“ã®å‡¦ç† (*text* â†’ <em>text</em>)
      processed = processed.replace(/\*(.*?)\*/g, '<em>$1</em>');
      
      // 5. è¦‹å‡ºã—ã®å‡¦ç†
      processed = processed.replace(/^#\s+(.*?)(?=\n|$)/gm, '<h3 style="margin: 12px 0 6px 0; font-size: 16px; font-weight: 600; color: #111827;">$1</h3>');
      processed = processed.replace(/^##\s+(.*?)(?=\n|$)/gm, '<h4 style="margin: 10px 0 4px 0; font-size: 14px; font-weight: 600; color: #374151;">$1</h4>');
      
      // 6. ãƒªã‚¹ãƒˆã®å‡¦ç†ï¼ˆç®‡æ¡æ›¸ãï¼‰
      processed = processed.replace(/^â€¢\s+(.*?)(?=\n|$)/gm, '<li>$1</li>');
      processed = processed.replace(/(<li>.*?<\/li>)/s, '<ul style="margin: 8px 0; padding-left: 20px;">$1</ul>');
      
      // 7. æ”¹è¡Œã‚’<br>ã«å¤‰æ›ï¼ˆæœ€å¾Œã«å‡¦ç†ï¼‰
      processed = processed.replace(/\n/g, '<br>');
      
      // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šå‡¦ç†çµæœã‚’ç¢ºèª
      const processedBrTags = (processed.match(/<br>/g) || []).length;
      console.log(`æ”¹è¡Œå‡¦ç†: å…ƒã®æ”¹è¡Œæ•°=${originalNewlines}, å‡¦ç†å¾Œã®<br>æ•°=${processedBrTags}`);
      
      return processed;
    }

    // APIã¨ã®é€šä¿¡
    async function callChatAPI(message) {
      try {
        const response = await fetch('http://localhost:8000/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: message,
            chat_id: currentChatId
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('APIé€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        return null;
      }
    }

    // æ„å›³ç‰¹å®šæ©Ÿèƒ½ã®APIå‘¼ã³å‡ºã—
    async function callIntentAPI(endpoint, data) {
      try {
        const response = await fetch(`http://localhost:8000${endpoint}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return await response.json();
      } catch (error) {
        console.error('æ„å›³ç‰¹å®šAPIé€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        return null;
      }
    }

    // æ„å›³ç‰¹å®šã‚’é–‹å§‹
    async function startIntentClarification(userInput) {
      try {
        const response = await callIntentAPI('/intent/start', {
          user_input: userInput,
          chat_id: currentChatId
        });
        
        if (response && response.question) {
          // æ—©æœŸå®Œäº†ã®åˆ¤å®š
          if (response.question.is_complete) {
            // ååˆ†ãªæƒ…å ±ãŒå¾—ã‚‰ã‚ŒãŸã®ã§ç›´æ¥å›ç­”ã‚’ç”Ÿæˆ
            await completeIntentClarificationWithResponse();
            return null;
          }
          
          intentClarificationState.isActive = true;
          intentClarificationState.originalInput = userInput;
          intentClarificationState.currentQuestion = 1;
          intentClarificationState.questionHistory = [];
          intentClarificationState.answerHistory = [];
          
          // è³ªå•ã‚’è¡¨ç¤º
          displayIntentQuestion(response.question);
          return null; // æ„å›³ç‰¹å®šãŒé–‹å§‹ã•ã‚ŒãŸã“ã¨ã‚’ç¤ºã™ãŸã‚ã«nullã‚’è¿”ã™
        } else {
          // è³ªå•ãŒç”Ÿæˆã•ã‚Œãªã‹ã£ãŸå ´åˆã¯é€šå¸¸ã®æ¤œç´¢
          return await generateResponse(userInput);
        }
      } catch (error) {
        console.error('æ„å›³ç‰¹å®šé–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯é€šå¸¸ã®æ¤œç´¢ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        return await generateResponse(userInput);
      }
    }

    // æ„å›³ç‰¹å®šã®è³ªå•ã‚’è¡¨ç¤º
    function displayIntentQuestion(question) {
      const questionText = `ğŸ¤” **ã‚ˆã‚Šè©³ã—ã„æƒ…å ±ã‚’ãŠèã‹ã›ãã ã•ã„**\n\nè³ªå• ${question.question_number}/${question.max_questions}\n\n${question.question}`;
      
      addMessage(questionText, 'ai');
      
      // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å¤‰æ›´
      userInput.placeholder = "è‡ªç„¶ãªè¨€è‘‰ã§ãŠç­”ãˆãã ã•ã„";
    }

    // æ„å›³ç‰¹å®šã®å›ç­”ã‚’å‡¦ç†ï¼ˆè‡ªç„¶è¨€èªï¼‰
    async function processIntentAnswer(userAnswer) {
      try {
        // å›ç­”ã‚’è¨˜éŒ²
        intentClarificationState.answerHistory.push(userAnswer);
        
        // æ¬¡ã®è³ªå•ã‚’ç”Ÿæˆ
        const nextQuestionNumber = intentClarificationState.currentQuestion + 1;
        
        if (nextQuestionNumber <= intentClarificationState.maxQuestions) {
          // æ¬¡ã®è³ªå•ã‚’è¡¨ç¤º
          const response = await callIntentAPI('/intent/question', {
            user_input: intentClarificationState.originalInput,
            question_number: nextQuestionNumber,
            answers: intentClarificationState.answerHistory
          });
          
          if (response && response.question) {
            // æ—©æœŸå®Œäº†ã®åˆ¤å®š
            if (response.question.is_complete) {
              // ååˆ†ãªæƒ…å ±ãŒå¾—ã‚‰ã‚ŒãŸã®ã§ç›´æ¥å›ç­”ã‚’ç”Ÿæˆ
              await completeIntentClarificationWithResponse();
              return;
            }
            
            intentClarificationState.currentQuestion = nextQuestionNumber;
            displayIntentQuestion(response.question);
          } else {
            // è³ªå•ãŒç”Ÿæˆã•ã‚Œãªã‹ã£ãŸå ´åˆã¯æ„å›³ç‰¹å®šã‚’å®Œäº†
            await completeIntentClarification();
          }
        } else {
          // æ„å›³ç‰¹å®šã‚’å®Œäº†
          await completeIntentClarification();
        }
      } catch (error) {
        console.error('æ„å›³ç‰¹å®šå›ç­”å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯æ„å›³ç‰¹å®šã‚’å®Œäº†
        await completeIntentClarification();
      }
    }

    // æ„å›³ç‰¹å®šã‚’å®Œäº†
    async function completeIntentClarification() {
      try {
        const response = await callIntentAPI('/intent/complete', {
          user_input: intentClarificationState.originalInput,
          answers: intentClarificationState.answerHistory
        });
        
        if (response) {
          intentClarificationState.userIntent = response;
          
          // æ„å›³ã«åŸºã¥ã„ã¦ãƒŠãƒ¬ãƒƒã‚¸ã‚’æ¤œç´¢
          const knowledgeResponse = await callIntentAPI('/knowledge/search-by-intent', response);
          
          if (knowledgeResponse) {
            let resultMessage = `ç†è§£ã—ã¾ã—ãŸï¼\n\n`;
            resultMessage += knowledgeResponse.explanation + '\n\n';
            
            if (knowledgeResponse.knowledge_files && knowledgeResponse.knowledge_files.length > 0) {
              resultMessage += displaySearchResults(knowledgeResponse.knowledge_files, intentClarificationState.originalInput);
            }
            
            addMessage(resultMessage, 'ai');
          }
          
          // æ„å›³ç‰¹å®šãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
          intentClarificationState.isActive = false;
          userInput.placeholder = "è³ªå•ã—ã¦ã¿ã¾ã—ã‚‡ã†"; // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å…ƒã«æˆ»ã™
        }
      } catch (error) {
        console.error('æ„å›³ç‰¹å®šå®Œäº†ã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯é€šå¸¸ã®æ¤œç´¢ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        const fallbackResponse = await generateResponse(intentClarificationState.originalInput);
        addMessage(fallbackResponse, 'ai');
        
        // æ„å›³ç‰¹å®šãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
        intentClarificationState.isActive = false;
        userInput.placeholder = "è³ªå•ã—ã¦ã¿ã¾ã—ã‚‡ã†";
      }
    }

    // æ—©æœŸå®Œäº†æ™‚ã«ç›´æ¥å›ç­”ã‚’ç”Ÿæˆ
    async function completeIntentClarificationWithResponse() {
      try {
        const response = await callIntentAPI('/intent/complete-with-response', {
          user_input: intentClarificationState.originalInput,
          answers: intentClarificationState.answerHistory
        });
        
        if (response) {
          let resultMessage = `ç†è§£ã—ã¾ã—ãŸï¼\n\n`;
          resultMessage += response.response + '\n\n';
          
          if (response.knowledge_files && response.knowledge_files.length > 0) {
            resultMessage += displaySearchResults(response.knowledge_files, intentClarificationState.originalInput);
          }
          
          addMessage(resultMessage, 'ai');
          
          // æ„å›³ç‰¹å®šãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
          intentClarificationState.isActive = false;
          userInput.placeholder = "è³ªå•ã—ã¦ã¿ã¾ã—ã‚‡ã†"; // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å…ƒã«æˆ»ã™
        }
      } catch (error) {
        console.error('æ—©æœŸå®Œäº†å›ç­”ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯é€šå¸¸ã®æ¤œç´¢ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        const fallbackResponse = await generateResponse(intentClarificationState.originalInput);
        addMessage(fallbackResponse, 'ai');
        
        // æ„å›³ç‰¹å®šãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
        intentClarificationState.isActive = false;
        userInput.placeholder = "è³ªå•ã—ã¦ã¿ã¾ã—ã‚‡ã†";
      }
    }

    // æ„å›³ç‰¹å®šã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆç¾åœ¨ã¯ä½¿ç”¨ã—ã¦ã„ãªã„ï¼‰
    function cancelIntentClarification() {
      intentClarificationState.isActive = false;
      addMessage("ä½•ã‹ã”è³ªå•ãŒã”ã–ã„ã¾ã—ãŸã‚‰ãŠèã‹ã›ãã ã•ã„ã€‚", 'ai');
      userInput.placeholder = "è³ªå•ã—ã¦ã¿ã¾ã—ã‚‡ã†"; // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å…ƒã«æˆ»ã™
    }

    // æ¤œç´¢æ©Ÿèƒ½ä»˜ãå¿œç­”ç”Ÿæˆ
    async function generateResponse(userMessage) {
      try {
        // APIã‚’å‘¼ã³å‡ºã—
        const apiResponse = await callChatAPI(userMessage);
        
        if (apiResponse && apiResponse.response) {
          // APIã‹ã‚‰ã®å¿œç­”ã‚’è¡¨ç¤º
          let response = apiResponse.response;
          
          // é–¢é€£ãƒŠãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ è¡¨ç¤º
          if (apiResponse.knowledge_files && apiResponse.knowledge_files.length > 0) {
            response += `\n\nğŸ“š **é–¢é€£ãƒŠãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«**\n\n`;
            response += displaySearchResults(apiResponse.knowledge_files, userMessage);
          }
          
          return response;
        } else {
          // APIãŒå¤±æ•—ã—ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          return `ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ãŒã€ç¾åœ¨ã‚·ã‚¹ãƒ†ãƒ ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚\n\nä»¥ä¸‹ã®ã‚ˆã†ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ãŠè©¦ã—ãã ã•ã„ï¼š\nâ€¢ å»ºè¨­æ¥­ç•Œ\nâ€¢ å¥³æ€§æ´»èº\nâ€¢ çµ„ç¹”é¢¨åœŸæ”¹é©\nâ€¢ ç¾å ´è·äºº\nâ€¢ åƒãæ–¹æ”¹é©\nâ€¢ æ–°å’æ¡ç”¨\nâ€¢ ç®¡ç†è·è‚²æˆ`;
        }
      } catch (error) {
        console.error('å¿œç­”ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
        return `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;
      }
    }

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’èª­ã¿è¾¼ã¿
    function loadChatHistory() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const data = JSON.parse(saved);
          chatSessions = data.sessions || [];
          sessionCounter = data.counter || 0;
          
          // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’è¡¨ç¤º
          chatSessions.forEach(session => {
            addChatHistoryItem(session.title, session.id);
          });
        }
      } catch (error) {
        console.error('ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ä¿å­˜
    function saveChatHistory() {
      try {
        // æœ€å¤§ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°ã‚’è¶…ãˆãŸå ´åˆã€å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
        if (chatSessions.length > MAX_SESSIONS) {
          chatSessions = chatSessions.slice(-MAX_SESSIONS);
        }
        
        const data = {
          sessions: chatSessions,
          counter: sessionCounter,
          lastSaved: new Date().toISOString()
        };
        
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (error) {
        console.error('ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // æ¤œç´¢æ©Ÿèƒ½
    function searchChatHistory(query) {
      const queryLower = query.toLowerCase();
      const historyItems = document.querySelectorAll('.chat-history-item');
      
      historyItems.forEach(item => {
        const title = item.querySelector('.chat-history-title').textContent;
        const chatId = item.getAttribute('data-chat-id');
        const session = chatSessions.find(s => s.id === chatId);
        
        let hasMatch = title.toLowerCase().includes(queryLower);
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã‚‚æ¤œç´¢
        if (session && session.messages) {
          hasMatch = hasMatch || session.messages.some(msg => 
            msg.content.toLowerCase().includes(queryLower)
          );
        }
        
        if (hasMatch) {
          item.style.display = 'flex';
          item.classList.add('highlight');
          
          // ã‚¿ã‚¤ãƒˆãƒ«ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è¿½åŠ 
          const titleElement = item.querySelector('.chat-history-title');
          if (query && title.toLowerCase().includes(queryLower)) {
            const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
            titleElement.innerHTML = title.replace(regex, '<span class="highlight-text">$1</span>');
          }
        } else {
          item.style.display = 'none';
          item.classList.remove('highlight');
        }
      });
    }

    // æ­£è¦è¡¨ç¾ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    function toggleSearch() {
      const isVisible = searchContainer.style.display !== 'none';
      searchContainer.style.display = isVisible ? 'none' : 'block';
      
      if (!isVisible) {
        chatSearchInput.focus();
      } else {
        chatSearchInput.value = '';
        // æ¤œç´¢çµæœã‚’ã‚¯ãƒªã‚¢
        document.querySelectorAll('.chat-history-item').forEach(item => {
          item.style.display = 'flex';
          item.classList.remove('highlight');
          const titleElement = item.querySelector('.chat-history-title');
          titleElement.innerHTML = titleElement.textContent;
        });
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    sendButton.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    // æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    newChatButton.addEventListener('click', startNewChat);

    // æ¤œç´¢é–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    searchToggle.addEventListener('click', toggleSearch);
    chatSearchInput.addEventListener('input', (e) => {
      searchChatHistory(e.target.value);
    });

    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’èª­ã¿è¾¼ã¿
    loadChatHistory();

    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    userInput.focus();
  </script>
</body>
</html> 